name: FreeBSD Build & Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 关键修复：将 build-freebsd-14.3 改为 build-freebsd-14-3（移除小数点）
  build-freebsd-14-3:
    runs-on: macos-13  # 必须用 macOS 宿主（支持 VirtualBox 运行 FreeBSD VM）
    name: Build on FreeBSD 14.3-RELEASE-p5 (amd64)
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Build in FreeBSD 14.3 VM
        uses: vmactions/freebsd-vm@v1
        with:
          release: 14.3  # 这里仍保留 14.3（是 VM 版本参数，允许小数点）
          arch: amd64
          usesh: true
          ssh_port: 2222
          enable_password: true
          password: root
          prepare: |
            pkg update -f
            pkg install -y \
              automake \
              autoconf \
              fltk \
              gmake \
              gcc \
              g++ \
              zlib-devel \
              mbedtls-devel \
              libpng-devel \
              libjpeg-turbo-devel \
              libwebp-devel
          run: |
            PKG_NAME="dillo"
            PKG_VERSION="3.2.0"
            FREEBSD_VERSION="14.3-RELEASE-p5"
            ARCH="amd64"
            PKG_DEST="/tmp/artifacts"
            BUILD_DIR="./build"

            mkdir -p $BUILD_DIR $PKG_DEST
            cd $BUILD_DIR || exit 1

            ../autogen.sh || { echo "autogen 失败"; exit 1; }
            ../configure \
              CPPFLAGS="-I/usr/local/include" \
              LDFLAGS="-L/usr/local/lib" \
              --prefix=/usr/local \
              --disable-threaded-dns || { echo "configure 失败"; exit 1; }
            gmake -j$(nproc) || { echo "编译失败"; exit 1; }
            gmake install DESTDIR=$(pwd)/pkg-root || { echo "安装失败"; exit 1; }

            PKG_DIR="$PKG_DEST/$PKG_NAME-$PKG_VERSION-$FREEBSD_VERSION-$ARCH"
            mkdir -p $PKG_DIR/usr/local
            cp -r $(pwd)/pkg-root/usr/local/* $PKG_DIR/usr/local/

            cat > $PKG_DIR/+MANIFEST << EOF
            name: $PKG_NAME
            version: $PKG_VERSION
            origin: www/dillo
            arch: $ARCH
            osversion: 1403005
            desc: "A small and fast web browser (built for FreeBSD 14.3)"
            maintainer: $GITHUB_ACTOR@users.noreply.github.com
            prefix: /usr/local
            dependencies:
              - fltk
              - mbedtls
              - libpng
              - libjpeg-turbo
              - libwebp
              - zlib
            EOF

            cd $PKG_DEST || exit 1
            tar -Jcvf $PKG_NAME-$PKG_VERSION-$FREEBSD_VERSION-$ARCH.txz $PKG_DIR

      - name: Extract package from FreeBSD VM
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            set -x  # 开启调试输出（方便排查问题）
            mkdir -p ./artifacts
            ssh-keyscan -p 2222 localhost >> ~/.ssh/known_hosts
            scp -o StrictHostKeyChecking=no -P 2222 root@localhost:/tmp/artifacts/*.txz ./artifacts/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dillo-freebsd-14.3-amd64
          path: ./artifacts/*.txz
          retention-days: 30
