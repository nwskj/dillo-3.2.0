name: FreeBSD CI (OpenSSL 3)

on:
  pull_request:
  push:
    branches: main

jobs:
  freebsd-14-openssl-3:
    runs-on: ubuntu-latest
    name: Build & Test on FreeBSD 14.0 (OpenSSL 3)
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: FreeBSD VM Build & Test
        id: freebsd-build
        # å›é€€åˆ°å­˜åœ¨çš„ v1 ç‰ˆæœ¬ï¼ˆä¿®å¤ç‰ˆæœ¬ä¸å­˜åœ¨é—®é¢˜ï¼‰
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.0"
          arch: amd64
          usesh: true
          # å…³é”®ï¼šv1 ç‰ˆæœ¬éœ€é€šè¿‡ nat é…ç½®å¯ç”¨ç½‘ç»œï¼Œé¿å… DNS è§£æå¤±è´¥
          nat: true
          prepare: |
            set -x
            # å¼ºåˆ¶æ›´æ–°è½¯ä»¶æºï¼Œå¢åŠ è¶…æ—¶é‡è¯•
            pkg update -f --timeout 300 || { echo "âŒ pkg update å¤±è´¥"; exit 1; }
            # å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆé€‚é… FreeBSD 14.0 è½¯ä»¶æºï¼‰
            pkg install -y \
              automake \
              autoconf \
              fltk \
              gcc \
              g++ \
              gmake \
              openssl \
              openssl-devel \
              libpng-devel \
              libjpeg-turbo-devel \
              libwebp-devel \
              zlib-devel || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
            # éªŒè¯ OpenSSL ç‰ˆæœ¬ï¼ˆç¡®ä¿ä¸º 3.xï¼‰
            openssl version || { echo "âŒ OpenSSL æœªå®‰è£…"; exit 1; }
            set +x
          run: |
            set -x
            # 1. ä¿®å¤è„šæœ¬æ‰§è¡Œæƒé™
            chmod +x autogen.sh || { echo "âŒ èµ‹äºˆ autogen.sh æ‰§è¡Œæƒé™å¤±è´¥"; exit 1; }
            
            # 2. ç”Ÿæˆé…ç½®è„šæœ¬
            ./autogen.sh || { echo "âŒ autogen å¤±è´¥"; exit 1; }
            
            # 3. é…ç½®ç¼–è¯‘å‚æ•°ï¼ˆé€‚é… FreeBSD 14.0 åº“è·¯å¾„ï¼‰
            ./configure \
              CPPFLAGS="-I/usr/local/include -I/usr/local/include/openssl" \
              LDFLAGS="-L/usr/local/lib -L/usr/local/lib/openssl -lm" \
              --disable-mbedtls \
              --enable-openssl || { echo "âŒ configure å¤±è´¥"; cat config.log; exit 1; }
            
            # 4. å¹¶è¡Œç¼–è¯‘ï¼ˆé™åˆ¶æ ¸å¿ƒæ•°ï¼Œé¿å… VM èµ„æºè€—å°½ï¼‰
            gmake -j$(expr $(nproc) / 2) || { echo "âŒ ç¼–è¯‘å¤±è´¥"; exit 1; }
            
            # 5. è¿è¡Œæµ‹è¯•
            make check || { echo "âŒ æµ‹è¯•å¤±è´¥"; cat test/html/test-suite.log; exit 1; }
            
            # 6. éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–
            ldd src/dillo || { echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–ç¼ºå¤±"; exit 1; }
            
            # 7. è¾“å‡ºå…³é”®ä¿¡æ¯
            echo "âœ… æ„å»º+æµ‹è¯•å®Œæˆï¼"
            echo "ğŸ“Œ äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼š$(realpath src/dillo)"
            echo "ğŸ“Œ OpenSSL ç‰ˆæœ¬ï¼š$(openssl version)"
            set +x
