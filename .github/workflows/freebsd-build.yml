name: FreeBSD CI (OpenSSL 3)

on:
  pull_request:
  push:
    branches: main

jobs:
  freebsd-14-openssl-3:
    # ç§»é™¤ä¸å¿…è¦çš„ä¾èµ–ï¼ˆåŸ needs: ubuntu-latest-html-testsï¼Œæ”¹ä¸ºç‹¬ç«‹æ‰§è¡Œï¼‰
    runs-on: ubuntu-latest
    name: Build & Test on FreeBSD 14.0 (OpenSSL 3)
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°æäº¤ï¼ŒåŠ é€Ÿæµç¨‹

      - name: FreeBSD VM Build & Test
        id: freebsd-build
        # å‡çº§åˆ° v2 ç‰ˆæœ¬ï¼ˆä¿®å¤ DNS è§£æã€macOS 15 å…¼å®¹é—®é¢˜ï¼‰
        uses: vmactions/freebsd-vm@v2
        with:
          release: "14.0"
          arch: amd64
          usesh: true
          # å…³é”®ï¼šå®‰è£…å®Œæ•´ä¾èµ–ï¼ˆOpenSSL 3 + å›¾ç‰‡åº“ + ç¼–è¯‘å·¥å…·ï¼‰
          prepare: |
            set -x
            # å¼ºåˆ¶æ›´æ–°è½¯ä»¶æºï¼Œé¿å…åŒ…ç¼“å­˜è¿‡æœŸ
            pkg update -f --timeout 300 || { echo "âŒ pkg update å¤±è´¥"; exit 1; }
            # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆOpenSSL 3 + ç¼–è¯‘å·¥å…· + å›¾ç‰‡å¤„ç†åº“ï¼‰
            pkg install -y \
              automake \
              autoconf \
              fltk \
              gcc \
              g++ \
              gmake \
              openssl \
              openssl-devel \
              libpng-devel \
              libjpeg-turbo-devel \
              libwebp-devel \
              zlib-devel || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
            # éªŒè¯ OpenSSL ç‰ˆæœ¬ï¼ˆç¡®ä¿æ˜¯ 3.xï¼‰
            openssl version || { echo "âŒ OpenSSL æœªå®‰è£…"; exit 1; }
            set +x
          # æ„å»º+æµ‹è¯•æ ¸å¿ƒæµç¨‹
          run: |
            set -x
            # 1. æƒé™ä¿®å¤ï¼ˆç¡®ä¿è„šæœ¬å¯æ‰§è¡Œï¼‰
            chmod +x autogen.sh || { echo "âŒ èµ‹äºˆ autogen.sh æ‰§è¡Œæƒé™å¤±è´¥"; exit 1; }
            
            # 2. ç”Ÿæˆé…ç½®è„šæœ¬
            ./autogen.sh || { echo "âŒ autogen å¤±è´¥ï¼ˆç¼ºå°‘ autoconf/automakeï¼‰"; exit 1; }
            
            # 3. é…ç½®ç¼–è¯‘å‚æ•°ï¼ˆæ˜ç¡®æŒ‡å®š OpenSSL è·¯å¾„ï¼Œç¦ç”¨ mbedtlsï¼‰
            ./configure \
              CPPFLAGS="-I/usr/local/include -I/usr/local/include/openssl" \
              LDFLAGS="-L/usr/local/lib -L/usr/local/lib/openssl -lm" \
              --disable-mbedtls \
              --enable-openssl || { echo "âŒ configure å¤±è´¥"; cat config.log; exit 1; }
            
            # 4. å¹¶è¡Œç¼–è¯‘ï¼ˆé™åˆ¶æ ¸å¿ƒæ•°ï¼Œé¿å… VM èµ„æºè€—å°½ï¼‰
            gmake -j$(expr $(nproc) / 2) || { echo "âŒ ç¼–è¯‘å¤±è´¥"; exit 1; }
            
            # 5. è¿è¡Œæµ‹è¯•
            make check || { echo "âŒ æµ‹è¯•å¤±è´¥"; cat test/html/test-suite.log; exit 1; }
            
            # 6. éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ£€æŸ¥ä¾èµ–åº“æ˜¯å¦å®Œæ•´ï¼‰
            ldd src/dillo || { echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–ç¼ºå¤±"; exit 1; }
            
            # 7. è¾“å‡ºå…³é”®ä¿¡æ¯ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
            echo "âœ… æ„å»º+æµ‹è¯•å®Œæˆï¼"
            echo "ğŸ“Œ äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼š$(realpath src/dillo)"
            echo "ğŸ“Œ OpenSSL ç‰ˆæœ¬ï¼š$(openssl version)"
            set +x
