name: FreeBSD Build and Package

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-freebsd:
    runs-on: macos-13  # 使用macOS作为宿主系统运行FreeBSD虚拟机

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Build in FreeBSD VM
      uses: vmactions/freebsd-vm@v1
      with:
        usesh: true
        prepare: |
          pkg update -f
          pkg install -y \
            autoconf \
            automake \
            fltk \
            gmake \
            gcc \
            g++ \
            zlib-devel \
            libssl-devel \
            libpng-devel \
            libjpeg-turbo-devel \
            webp-devel
        run: |
          # 定义变量
          PKGNAME="dillo"
          PKGVERSION="3.2.0"
          ARCH="amd64"
          PKGDEST="./packages"
          WRKSRC="./work"

          # 创建工作目录
          mkdir -p $WRKSRC $PKGDEST
          cd $WRKSRC || exit 1

          # 复制源码
          cp -r ../. dillo
          cd dillo || exit 1

          # 生成配置文件
          ./autogen.sh || exit 1

          # 创建构建目录
          mkdir -p build && cd build || exit 1

          # 配置编译选项
          ../configure \
            --prefix=/usr/local \
            CPPFLAGS='-I/usr/local/include' \
            LDFLAGS='-L/usr/local/lib' || exit 1

          # 编译
          gmake || exit 1

          # 安装到临时目录
          DESTDIR=$WRKSRC/stage gmake install || exit 1

          # 创建打包目录结构
          mkdir -p $PKGDEST/$PKGNAME-$PKGVERSION-$ARCH/usr/local
          cp -r $WRKSRC/stage/usr/local/* $PKGDEST/$PKGNAME-$PKGVERSION-$ARCH/usr/local/

          # 生成打包信息
          cat > $PKGDEST/$PKGNAME-$PKGVERSION-$ARCH/+MANIFEST << EOF
          name: $PKGNAME
          version: $PKGVERSION
          origin: www/dillo
          arch: $ARCH
          desc: A small and fast web browser
          maintainer: $GITHUB_ACTOR@users.noreply.github.com
          prefix: /usr/local
          EOF

          # 打包为txz格式
          cd $PKGDEST || exit 1
          tar -Jcvf $PKGNAME-$PKGVERSION-$ARCH.txz $PKGNAME-$PKGVERSION-$ARCH

          # 复制到宿主系统可访问的目录
          mkdir -p /tmp/artifacts
          cp $PKGNAME-$PKGVERSION-$ARCH.txz /tmp/artifacts/

    - name: Extract artifacts from VM
      run: |
        # 从FreeBSD VM中复制打包好的文件到宿主系统
        mkdir -p artifacts
        docker cp freebsd-vm:/tmp/artifacts/. artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4  # 更新为v4版本
      with:
        name: dillo-freebsd-amd64
        path: artifacts/*.txz
        retention-days: 30  # v4版本需要显式指定保留天数（可选，默认90天）

    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2  # 同时更新此动作到最新版
      with:
        files: artifacts/*.txz
        name: Dillo ${{ github.ref_name }}
        draft: false
        prerelease: false
