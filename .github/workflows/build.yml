name: Multi-Platform Build and Package

on:
  pull_request:
  push:
    branches: main

jobs:
  # Linux ARM64 构建与打包
  linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装交叉编译依赖
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu autoconf automake make \
            libfltk1.3-dev:arm64 libssl-dev:arm64 libpng-dev:arm64 libjpeg-dev:arm64 \
            libwebp-dev:arm64 libbrotli-dev:arm64 binutils-aarch64-linux-gnu

      - name: 生成配置脚本
        run: ./autogen.sh

      - name: 创建构建目录
        run: mkdir -p build arm64-install

      - name: 配置交叉编译
        run: |
          cd build
          ../configure --host=aarch64-linux-gnu \
            --prefix=$(readlink -f ../arm64-install) \
            --enable-html-tests \
            CC=aarch64-linux-gnu-gcc \
            CXX=aarch64-linux-gnu-g++

      - name: 编译与安装
        run: |
          cd build
          make -j$(nproc)
          make install

      - name: 打包构建产物
        run: |
          cd arm64-install
          tar -czvf ../dillo-linux-arm64.tar.gz *

      - name: 上传构建产物
        uses: actions/upload-artifact@v3
        with:
          name: dillo-linux-arm64
          path: dillo-linux-arm64.tar.gz

  # Linux AMD64 构建与打包
  linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装依赖
        run: |
          sudo apt update
          sudo apt install -y libfltk1.3-dev libssl-dev libpng-dev libjpeg-dev \
            libwebp-dev libbrotli-dev autoconf automake make

      - name: 生成配置脚本
        run: ./autogen.sh

      - name: 创建构建目录
        run: mkdir -p build amd64-install

      - name: 配置构建
        run: |
          cd build
          ../configure --prefix=$(readlink -f ../amd64-install) --enable-html-tests

      - name: 编译与安装
        run: |
          cd build
          make -j$(nproc)
          make install

      - name: 打包构建产物
        run: |
          cd amd64-install
          tar -czvf ../dillo-linux-amd64.tar.gz *

      - name: 上传构建产物
        uses: actions/upload-artifact@v3
        with:
          name: dillo-linux-amd64
          path: dillo-linux-amd64.tar.gz

  # Windows x64 构建与打包 (Cygwin)
  windows-64:
    runs-on: windows-latest
    steps:
      - run: git config --global core.autocrlf input

      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装 Cygwin 与依赖
        uses: cygwin/cygwin-install-action@master
        with:
          packages: >
            gcc-core gcc-g++ autoconf automake make zlib-devel mbedtls-devel
            libfltk-devel libiconv-devel libpng-devel libjpeg-devel
            libwebp-devel libgif-devel libbrotli-devel zip

      - name: 构建与安装
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          set -x
          cd ${GITHUB_WORKSPACE}
          ./autogen.sh
          ./configure --prefix=/usr/local
          make -j$(nproc)
          make install

      - name: 打包构建产物
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr '{0}'
        run: |
          cd /usr/local
          zip -r ${GITHUB_WORKSPACE}/dillo-windows-64.zip *

      - name: 上传构建产物
        uses: actions/upload-artifact@v3
        with:
          name: dillo-windows-64
          path: dillo-windows-64.zip

  # FreeBSD amd64 构建与打包
  freebsd-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: FreeBSD 构建与打包
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.0"
          usesh: true
          prepare: |
            set -x
            pkg install -y automake fltk libssl-dev libpng libjpeg-turbo libwebp brotli

          run: |
            set -x
            ./autogen.sh
            ./configure CPPFLAGS='-I/usr/local/include' LDFLAGS='-L/usr/local/lib' --prefix=/usr/local
            make -j$(nproc)
            make install
            cd /usr/local
            tar -czvf ${GITHUB_WORKSPACE}/dillo-freebsd-amd64.tar.gz *

      - name: 上传构建产物
        uses: actions/upload-artifact@v3
        with:
          name: dillo-freebsd-amd64
          path: dillo-freebsd-amd64.tar.gz
