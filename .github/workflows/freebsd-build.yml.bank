name: FreeBSD Build & Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-freebsd-14-3:
    # 关键修复1：替换废弃的 macos-13 为 macos-15-intel（Intel 架构，兼容 VirtualBox）
    runs-on: macos-15-intel
    name: Build on FreeBSD 14.3-RELEASE-p5 (amd64)
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Build in FreeBSD 14.3 VM
        uses: vmactions/freebsd-vm@v1
        with:
          release: 14.3
          arch: amd64
          usesh: true
          # 移除无效的 sync 参数，改用 Action 内置共享目录 /vagrant（100% 稳定同步）
          prepare: |
            # 关键优化：开启调试输出，显示所有命令执行细节
            set -x
            # 强制更新软件源，解决包缓存过期问题
            pkg update -f || { echo "❌ pkg update 失败"; exit 1; }
            # 逐个安装依赖，明确报错点（避免批量安装隐藏失败）
            pkg install -y automake || { echo "❌ automake 安装失败"; exit 1; }
            pkg install -y autoconf || { echo "❌ autoconf 安装失败"; exit 1; }
            pkg install -y fltk || { echo "❌ fltk 安装失败"; exit 1; }
            pkg install -y gmake || { echo "❌ gmake 安装失败"; exit 1; }
            pkg install -y gcc || { echo "❌ gcc 安装失败"; exit 1; }
            pkg install -y g++ || { echo "❌ g++ 安装失败"; exit 1; }
            pkg install -y zlib-devel || { echo "❌ zlib-devel 安装失败"; exit 1; }
            pkg install -y mbedtls-devel || { echo "❌ mbedtls-devel 安装失败"; exit 1; }
            pkg install -y libpng-devel || { echo "❌ libpng-devel 安装失败"; exit 1; }
            pkg install -y libjpeg-turbo-devel || { echo "❌ libjpeg-turbo-devel 安装失败"; exit 1; }
            pkg install -y libwebp-devel || { echo "❌ libwebp-devel 安装失败"; exit 1; }
            # 验证依赖是否安装成功（可选，进一步确保）
            pkg info fltk mbedtls libpng || { echo "❌ 核心依赖未找到"; exit 1; }
            set +x
          run: |
            # 开启调试输出，便于排查问题
            set -x
            # 定义参数（使用 /vagrant 共享目录，默认同步到宿主工作目录）
            PKG_NAME="dillo"
            PKG_VERSION="3.2.0"
            FREEBSD_VERSION="14.3-RELEASE-p5"
            ARCH="amd64"
            # 关键：PKG_DEST 指向 VM 中的 /vagrant/artifacts（自动同步到宿主 ./artifacts）
            PKG_DEST="/vagrant/artifacts"
            BUILD_DIR="./build"

            # 创建目录（确保权限可写）
            mkdir -p $BUILD_DIR $PKG_DEST || { echo "❌ 创建目录失败"; exit 1; }
            cd $BUILD_DIR || { echo "❌ 进入 build 目录失败"; exit 1; }

            # 生成配置脚本（针对 Git 源码）
            ../autogen.sh || { echo "❌ autogen 失败（可能缺少 autoconf/automake）"; exit 1; }
            # 配置编译参数（明确指定库路径，避免 FreeBSD 路径问题）
            ../configure \
              CPPFLAGS="-I/usr/local/include -I/usr/local/include/fltk" \
              LDFLAGS="-L/usr/local/lib -L/usr/local/lib/fltk" \
              --prefix=/usr/local \
              --disable-threaded-dns || { echo "❌ configure 失败（可能缺少依赖库）"; exit 1; }
            # 并行编译（使用所有 CPU 核心，加速构建）
            gmake -j$(nproc) || { echo "❌ 编译失败（查看编译日志）"; exit 1; }
            # 安装到临时目录（DESTDIR 避免污染 VM 系统）
            gmake install DESTDIR=$(pwd)/pkg-root || { echo "❌ 安装失败"; exit 1; }

            # 构建 FreeBSD 标准包结构
            PKG_DIR="$PKG_DEST/$PKG_NAME-$PKG_VERSION-$FREEBSD_VERSION-$ARCH"
            mkdir -p $PKG_DIR/usr/local || { echo "❌ 创建包目录失败"; exit 1; }
            # 复制安装文件到包目录
            cp -r $(pwd)/pkg-root/usr/local/* $PKG_DIR/usr/local/ || { echo "❌ 复制文件失败"; exit 1; }

            # 生成 FreeBSD 包元数据（+MANIFEST 是 pkg 命令识别的必需文件）
            cat > $PKG_DIR/+MANIFEST << EOF
            name: $PKG_NAME
            version: $PKG_VERSION
            origin: www/dillo
            arch: $ARCH
            osversion: 1403005
            desc: "A small and fast web browser (built for FreeBSD 14.3-RELEASE-p5)"
            maintainer: $GITHUB_ACTOR@users.noreply.github.com
            prefix: /usr/local
            dependencies:
              - fltk
              - mbedtls
              - libpng
              - libjpeg-turbo
              - libwebp
              - zlib
            EOF

            # 打包为 FreeBSD 标准 txz 格式（-J 表示 xz 压缩，符合 pkg 规范）
            cd $PKG_DEST || { echo "❌ 进入 artifacts 目录失败"; exit 1; }
            tar -Jcvf $PKG_NAME-$PKG_VERSION-$FREEBSD_VERSION-$ARCH.txz $PKG_DIR || { echo "❌ 打包失败"; exit 1; }

            # 验证包文件是否生成（关键校验步骤）
            echo "✅ 打包完成，文件列表："
            ls -lh $PKG_DEST/*.txz || { echo "❌ 包文件未生成"; exit 1; }
            set +x

      - name: Verify artifact exists (宿主系统校验)
        run: |
          # 验证共享目录中的文件是否同步到宿主系统
          echo "✅ 宿主系统 artifacts 目录内容："
          ls -lh ./artifacts/*.txz
          # 若文件不存在，直接报错终止工作流
          if [ -z "$(ls -A ./artifacts/*.txz 2>/dev/null)" ]; then
            echo "❌ 错误：包文件未从 VM 同步到宿主系统"
            exit 1
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dillo-freebsd-14.3-amd64
          path: ./artifacts/*.txz
          retention-days: 30
